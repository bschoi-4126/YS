<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš©ì„±ì „ê¸°(ì£¼) í’‹ì‚´ íšŒë¹„ ê´€ë¦¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="max-w-md mx-auto p-4 space-y-4">
        
        <div class="text-center py-4">
            <h1 class="text-2xl font-black text-gray-800 flex justify-center items-center gap-2">
                <i class="fa-solid fa-soccer-ball animate-bounce text-blue-600"></i>
                ìš©ì„±ì „ê¸°(ì£¼) í’‹ì‚´ íšŒë¹„ ë‚´ì—­
            </h1>
        </div>

        <div class="bg-slate-800 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden">
            <div class="relative z-10">
                <p class="text-xs opacity-60 font-bold uppercase tracking-widest">í˜„ì¬ ì „ì²´ ì”ì•¡ (ì´ì›”ê¸ˆ í¬í•¨)</p>
                <div class="text-4xl font-black mt-2 text-green-400" id="totalBalance">0ì›</div>
                <div class="flex gap-2 mt-4">
                    <select id="viewYear" onchange="fetchData()" class="bg-white/10 border-none rounded-lg text-sm p-1 outline-none"></select>
                    <select id="viewMonth" onchange="fetchData()" class="bg-white/10 border-none rounded-lg text-sm p-1 outline-none"></select>
                </div>
            </div>
            <i class="fa-solid fa-coins absolute -right-4 -bottom-4 text-8xl opacity-10"></i>
        </div>

        <div class="bg-white rounded-2xl p-5 shadow-sm border border-red-100">
            <div class="flex justify-between items-center mb-3">
                <h2 class="font-bold text-red-500 text-sm"><i class="fa-solid fa-triangle-exclamation mr-1"></i> ì´ë²ˆ ë‹¬ ë¯¸ë‚©ì</h2>
                <span class="text-xs text-gray-400" id="unpaidCount">0ëª…</span>
            </div>
            <div id="unpaidList" class="flex flex-wrap gap-2"></div>
        </div>

        <div class="grid grid-cols-3 gap-2">
            <button onclick="showSection('members')" class="bg-white p-3 rounded-xl shadow-sm border text-center active:scale-95 transition">
                <i class="fa-solid fa-user-group text-blue-500 text-lg"></i>
                <p class="text-[10px] font-bold mt-1 text-gray-600">íšŒì›ê´€ë¦¬</p>
            </button>
            <button onclick="showSection('payment')" class="bg-white p-3 rounded-xl shadow-sm border text-center active:scale-95 transition">
                <i class="fa-solid fa-check-double text-green-500 text-lg"></i>
                <p class="text-[10px] font-bold mt-1 text-gray-600">íšŒë¹„ì…ë ¥</p>
            </button>
            <button onclick="showSection('income')" class="bg-white p-3 rounded-xl shadow-sm border text-center active:scale-95 transition">
                <i class="fa-solid fa-plus-minus text-orange-500 text-lg"></i>
                <p class="text-[10px] font-bold mt-1 text-gray-600">ìˆ˜ì…/ì§€ì¶œ</p>
            </button>
        </div>

        <div class="bg-white rounded-t-3xl p-6 shadow-inner min-h-[400px]">
            <h3 class="font-bold text-gray-700 mb-4 flex justify-between items-center">
                <span>ğŸ“… ì›”ë³„ ìƒì„¸ ë‚´ì—­</span>
                <span id="monthTitle" class="text-sm bg-blue-50 text-blue-600 px-3 py-1 rounded-full font-bold"></span>
            </h3>
            <div id="monthlyLogs" class="space-y-4"></div>
        </div>
    </div>

    <div id="actionSection" class="hidden fixed inset-0 bg-black/50 z-50 flex items-end">
        <div class="bg-white w-full rounded-t-3xl p-6 animate-slide-up max-h-[90vh] overflow-y-auto">
            <div id="sectionContent"></div>
            <button onclick="hideSection()" class="w-full mt-6 py-4 bg-gray-100 rounded-2xl font-bold text-gray-500">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbz3rsxELn2976--EQv27UarheFevKKpdPskF1viJ4AvZ2-Tizc78kbbcWmopXIQsG4Azw/exec';
        let appData = {};

        const now = new Date();
        const yearSel = document.getElementById('viewYear');
        const monthSel = document.getElementById('viewMonth');
        
        for(let i=2025; i<=2027; i++) {
            yearSel.innerHTML += `<option value="${i}" ${i==now.getFullYear()?'selected':''}>${i}ë…„</option>`;
        }
        for(let i=1; i<=12; i++) {
            monthSel.innerHTML += `<option value="${i}" ${i==now.getMonth()+1?'selected':''}>${i}ì›”</option>`;
        }

        async function fetchData() {
            const y = yearSel.value;
            const m = monthSel.value;
            document.getElementById('monthTitle').innerText = `${y}ë…„ ${m}ì›”`;
            
            try {
                const resp = await fetch(`${API_URL}?action=getData&year=${y}&month=${m}`);
                appData = await resp.json();
                renderUI();
            } catch (e) {
                console.error(e);
            }
        }

        function renderUI() {
            document.getElementById('totalBalance').innerText = appData.totalBalance.toLocaleString() + 'ì›';
            document.getElementById('unpaidCount').innerText = `${appData.unpaidMembers.length}ëª…`;
            document.getElementById('unpaidList').innerHTML = appData.unpaidMembers.map(m => 
                `<span class="bg-red-50 text-red-500 px-2 py-1 rounded text-xs font-bold border border-red-100">${m}</span>`).join('');

            document.getElementById('monthlyLogs').innerHTML = appData.monthlyLogs.map(l => `
                <div class="flex justify-between items-center border-b border-gray-50 pb-3">
                    <div>
                        <p class="text-[10px] text-gray-400 font-medium">${l.date.toString().split('T')[0]}</p>
                        <p class="font-bold text-gray-700 text-sm">${l.detail}</p>
                    </div>
                    <div class="${l.type === 'ìˆ˜ì…' ? 'text-blue-500' : 'text-red-500'} font-black text-sm text-right">
                        ${l.type === 'ìˆ˜ì…' ? '+' : '-'}${Number(l.amount).toLocaleString()}
                        <p class="text-[9px] opacity-40 font-normal text-gray-900">${l.type}</p>
                    </div>
                </div>
            `).join('') || '<p class="text-center text-gray-300 py-10 text-sm">í•´ë‹¹ ì›”ì˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        function showSection(type) {
            const section = document.getElementById('actionSection');
            const content = document.getElementById('sectionContent');
            section.classList.remove('hidden');

            if (type === 'payment') {
                content.innerHTML = `
                    <h3 class="font-black text-xl mb-4">ë‹¤ì¤‘ íšŒë¹„ ë‚©ë¶€ ì²´í¬</h3>
                    <p class="text-xs text-gray-400 mb-4">ë‚©ë¶€í•œ ì¸ì›ì„ ëª¨ë‘ ì„ íƒí•˜ê³  ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>
                    <div class="grid grid-cols-3 gap-2 max-h-60 overflow-y-auto mb-4" id="multiPayList">
                        ${appData.unpaidMembers.map(m => `
                            <label class="flex flex-col items-center p-3 border rounded-2xl has-[:checked]:bg-green-50 has-[:checked]:border-green-500 transition cursor-pointer">
                                <input type="checkbox" name="payMember" value="${m}" class="hidden">
                                <span class="text-sm font-bold">${m}</span>
                            </label>
                        `).join('')}
                    </div>
                    <button onclick="submitMultiPay()" class="w-full bg-green-500 text-white py-4 rounded-2xl font-bold shadow-lg shadow-green-100">ì„ íƒ ì™„ë£Œ ë° ì €ì¥</button>
                `;
            } else if (type === 'members') {
                content.innerHTML = `
                    <h3 class="font-black text-xl mb-4">íšŒì› ì¶”ê°€/ì‚­ì œ</h3>
                    <div class="flex gap-2 mb-6">
                        <input id="newMem" class="flex-1 bg-gray-100 border-none p-4 rounded-xl outline-none" placeholder="ìƒˆ íšŒì› ì´ë¦„">
                        <button onclick="addMem()" class="bg-blue-500 text-white px-6 rounded-xl font-bold">ì¶”ê°€</button>
                    </div>
                    <div class="grid grid-cols-2 gap-2 max-h-60 overflow-y-auto">
                        ${appData.members.map(m => `
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-xl text-sm border">
                                <span class="font-medium">${m}</span>
                                <i onclick="delMem('${m}')" class="fa-solid fa-circle-minus text-red-300 cursor-pointer hover:text-red-500 transition"></i>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (type === 'income') {
                content.innerHTML = `
                    <h3 class="font-black text-xl mb-4">ê¸°íƒ€ ì…ì¶œê¸ˆ ê¸°ë¡</h3>
                    <div class="space-y-4">
                        <div class="flex gap-2">
                            <button onclick="setTrType(this, 'ìˆ˜ì…')" class="flex-1 py-4 border rounded-2xl font-bold transition tr-btn active-income">ìˆ˜ì…</button>
                            <button onclick="setTrType(this, 'ì§€ì¶œ')" class="flex-1 py-4 border rounded-2xl font-bold transition tr-btn">ì§€ì¶œ</button>
                        </div>
                        <input id="trDate" type="date" class="w-full bg-gray-100 p-4 rounded-xl border-none outline-none" value="${new Date().toISOString().split('T')[0]}">
                        <input id="trDetail" class="w-full bg-gray-100 p-4 rounded-xl border-none outline-none" placeholder="í•­ëª© (ì˜ˆ: ìŒë£Œìˆ˜ êµ¬ì…, ì°¬ì¡°ê¸ˆ)">
                        <input id="trAmount" type="number" class="w-full bg-gray-100 p-4 rounded-xl border-none outline-none" placeholder="ê¸ˆì•¡ ì…ë ¥">
                        <button onclick="addTr()" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-bold shadow-xl">ë‚´ì—­ ì €ì¥í•˜ê¸°</button>
                    </div>
                `;
                window.trType = 'ìˆ˜ì…'; 
            }
        }

        function setTrType(el, type) {
            window.trType = type;
            document.querySelectorAll('.tr-btn').forEach(b => b.classList.remove('bg-blue-500', 'bg-red-500', 'text-white'));
            el.classList.add(type === 'ìˆ˜ì…' ? 'bg-blue-500' : 'bg-red-500');
            el.classList.add('text-white');
        }

        async function submitMultiPay() {
            const selected = Array.from(document.querySelectorAll('input[name="payMember"]:checked')).map(el => el.value);
            if(selected.length === 0) return alert('ë‚©ë¶€ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            if(!confirm(`${selected.join(', ')} ì¸ì›ì˜ íšŒë¹„ ë‚©ë¶€ë¥¼ ì²˜ë¦¬í• ê¹Œìš”?`)) return;
            await fetch(`${API_URL}?action=recordMultiPayments&names=${JSON.stringify(selected)}&year=${yearSel.value}&month=${monthSel.value}`);
            hideSection(); fetchData();
        }

        async function addMem() {
            const name = document.getElementById('newMem').value;
            if(!name) return;
            await fetch(`${API_URL}?action=addMember&name=${name}`);
            hideSection(); fetchData();
        }

        async function delMem(name) {
            if(confirm(`${name} íšŒì›ì„ ëª…ë‹¨ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                await fetch(`${API_URL}?action=deleteMember&name=${name}`);
                hideSection(); fetchData();
            }
        }

        async function addTr() {
            const type = window.trType;
            const detail = document.getElementById('trDetail').value;
            const amount = document.getElementById('trAmount').value;
            const date = document.getElementById('trDate').value;
            if(!detail || !amount) return alert('ë‚´ìš©ê³¼ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.');
            await fetch(`${API_URL}?action=addTransaction&type=${type}&detail=${detail}&amount=${amount}&date=${date}`);
            hideSection(); fetchData();
        }

        function hideSection() { document.getElementById('actionSection').classList.add('hidden'); }
        window.onload = fetchData;
    </script>
    <style>
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slide-up 0.3s ease-out; }
        .active-income { background-color: #3b82f6; color: white; }
    </style>
</body>
</html>
