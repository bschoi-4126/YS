<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš©ì„±ì „ê¸°(ì£¼) í’‹ì‚´ íšŒë¹„ ê´€ë¦¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @font-face { font-family: 'Pretendard-Regular'; src: url('https://cdn.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff') format('woff'); font-weight: 400; font-style: normal; }
        body { font-family: 'Pretendard-Regular', sans-serif; -webkit-tap-highlight-color: transparent; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        .active-tab { background-color: #3b82f6 !important; color: white !important; }
        input[type="checkbox"]:checked + span { background-color: #ecfdf5; border-color: #10b981; color: #065f46; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-10">

    <div class="max-w-md mx-auto p-4 space-y-4">
        
        <div class="text-center py-6">
            <h1 class="text-2xl font-black text-slate-800 flex justify-center items-center gap-2 italic">
                <i class="fa-solid fa-soccer-ball text-blue-600"></i>
                YONG SUNG FUTSAL
            </h1>
            <p class="text-[10px] text-slate-400 font-bold tracking-widest mt-1">ìš©ì„±ì „ê¸°(ì£¼) í’‹ì‚´ íšŒë¹„ ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
        </div>

        <div class="bg-gradient-to-br from-slate-900 via-slate-800 to-blue-900 rounded-[2.5rem] p-8 text-white shadow-2xl relative overflow-hidden border border-white/10">
            <div class="relative z-10">
                <p class="text-[10px] opacity-50 font-bold tracking-[0.2em] mb-1">TOTAL BALANCE</p>
                <div class="text-4xl font-black text-green-400 mb-6" id="totalBalance">0ì›</div>
                
                <div class="flex items-center gap-2 bg-white/10 w-fit p-1 rounded-xl border border-white/5">
                    <select id="viewYear" onchange="fetchData()" class="bg-transparent border-none text-xs font-bold p-1 outline-none cursor-pointer"></select>
                    <div class="w-[1px] h-3 bg-white/20"></div>
                    <select id="viewMonth" onchange="fetchData()" class="bg-transparent border-none text-xs font-bold p-1 outline-none cursor-pointer"></select>
                </div>
            </div>
            <i class="fa-solid fa-wallet absolute -right-6 -bottom-6 text-9xl opacity-10"></i>
        </div>

        <div class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100">
            <div class="flex justify-between items-center mb-5">
                <h2 class="font-bold text-sm text-slate-400 flex items-center">
                    <i class="fa-solid fa-clock-rotate-left mr-2 text-red-400"></i>ëˆ„ì  ë¯¸ë‚© ëª…ë‹¨
                </h2>
                <span class="bg-red-50 text-red-500 text-[10px] px-3 py-1 rounded-full font-black" id="unpaidSummaryCount">0ëª…</span>
            </div>
            <div id="unpaidList" class="space-y-3 max-h-48 overflow-y-auto pr-1">
                <p class="text-center text-slate-300 py-4 text-xs italic">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
        </div>

        <div class="grid grid-cols-3 gap-3">
            <button onclick="showSection('members')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center active:scale-95 transition">
                <div class="w-10 h-10 bg-indigo-50 rounded-full flex items-center justify-center mb-1">
                    <i class="fa-solid fa-users-gear text-indigo-500 text-sm"></i>
                </div>
                <span class="text-[10px] font-bold text-slate-600">ë©¤ë²„/íœ´ì‹</span>
            </button>
            <button onclick="showSection('payment')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center active:scale-95 transition">
                <div class="w-10 h-10 bg-emerald-50 rounded-full flex items-center justify-center mb-1">
                    <i class="fa-solid fa-hand-holding-dollar text-emerald-500 text-sm"></i>
                </div>
                <span class="text-[10px] font-bold text-slate-600">íšŒë¹„ì²´í¬</span>
            </button>
            <button onclick="showSection('income')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center active:scale-95 transition">
                <div class="w-10 h-10 bg-orange-50 rounded-full flex items-center justify-center mb-1">
                    <i class="fa-solid fa-receipt text-orange-500 text-sm"></i>
                </div>
                <span class="text-[10px] font-bold text-slate-600">ìˆ˜ì…/ì§€ì¶œ</span>
            </button>
        </div>

        <div class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100 min-h-[300px]">
            <h3 class="font-black text-slate-800 mb-6 flex justify-between items-center text-sm">
                <span>ğŸ“‘ <span id="monthLabel"></span> ìƒì„¸ ë‚´ì—­</span>
                <button onclick="fetchData()" class="text-slate-300 hover:text-blue-500 transition"><i class="fa-solid fa-rotate"></i></button>
            </h3>
            <div id="monthlyLogs" class="space-y-4">
                </div>
        </div>
    </div>

    <div id="actionSection" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-end">
        <div class="bg-white w-full rounded-t-[2.5rem] p-8 animate-slide-up max-h-[85vh] overflow-y-auto shadow-2xl">
            <div id="sectionContent"></div>
            <button onclick="hideSection()" class="w-full mt-8 py-4 bg-slate-100 rounded-2xl font-bold text-slate-400 hover:bg-slate-200 transition">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        /** [ì¤‘ìš”] ì œë¯¼ë‹˜ì˜ êµ¬ê¸€ ì›¹ ì•± URLì„ ì—¬ê¸°ì— ë„£ìœ¼ì„¸ìš” **/
        const API_URL = 'https://script.google.com/macros/s/AKfycbz3rsxELn2976--EQv27UarheFevKKpdPskF1viJ4AvZ2-Tizc78kbbcWmopXIQsG4Azw/exec';
        
        let appData = {};

        // ì´ˆê¸° ë‚ ì§œ ì„¤ì • (2025ë…„~2026ë…„)
        const now = new Date();
        const yearSel = document.getElementById('viewYear');
        const monthSel = document.getElementById('viewMonth');
        for(let i=2025; i<=2026; i++) yearSel.innerHTML += `<option value="${i}" ${i==now.getFullYear()?'selected':''}>${i}ë…„</option>`;
        for(let i=1; i<=12; i++) monthSel.innerHTML += `<option value="${i}" ${i==now.getMonth()+1?'selected':''}>${i}ì›”</option>`;

        async function fetchData() {
            const y = yearSel.value; const m = monthSel.value;
            document.getElementById('monthLabel').innerText = `${m}ì›”`;
            
            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            document.getElementById('monthlyLogs').innerHTML = '<p class="text-center text-slate-300 py-10 text-xs">ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</p>';
            
            try {
                const resp = await fetch(`${API_URL}?action=getData&year=${y}&month=${m}`);
                if (!resp.ok) throw new Error("êµ¬ê¸€ ì„œë²„ ì‘ë‹µ ì—ëŸ¬");
                appData = await resp.json();
                
                if(appData.error) {
                    alert("ì˜¤ë¥˜ ë°œìƒ: " + appData.error);
                    return;
                }
                renderUI();
            } catch (e) {
                console.error(e);
                alert("ì—°ë™ ì‹¤íŒ¨! êµ¬ê¸€ ì‹œíŠ¸ ë°°í¬ ìƒíƒœì™€ URLì„ í™•ì¸í•˜ì„¸ìš”.");
                document.getElementById('monthlyLogs').innerHTML = '<p class="text-center text-red-300 py-10 text-xs">ì—°ë™ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }

        function renderUI() {
            // ì”ì•¡
            document.getElementById('totalBalance').innerText = (appData.totalBalance || 0).toLocaleString() + 'ì›';
            
            // ëˆ„ì  ë¯¸ë‚© ëª…ë‹¨
            document.getElementById('unpaidSummaryCount').innerText = `${appData.unpaidSummary.length}ëª…`;
            document.getElementById('unpaidList').innerHTML = appData.unpaidSummary.map(u => `
                <div class="flex justify-between items-center bg-slate-50 p-3 rounded-2xl border border-slate-100">
                    <div>
                        <span class="font-bold text-slate-700 text-sm">${u.name}</span>
                        <p class="text-[9px] text-red-400 font-medium">${u.months.slice(-3).join(', ')}${u.months.length > 3 ? ' ì™¸' : ''} ë¯¸ë‚©</p>
                    </div>
                    <span class="bg-red-500 text-white text-[10px] px-2 py-1 rounded-lg font-black">${u.months.length}íšŒ</span>
                </div>
            `).join('') || '<p class="text-center text-emerald-500 font-bold text-xs py-4">ëª¨ë‘ ì™„ë‚©ì…ë‹ˆë‹¤! âš½</p>';

            // ì›”ë³„ ê°€ê³„ë¶€ ë¡œê·¸
            document.getElementById('monthlyLogs').innerHTML = appData.monthlyLogs.map(l => `
                <div class="flex justify-between items-center border-b border-slate-50 pb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 ${l.type === 'ìˆ˜ì…' ? 'bg-blue-50 text-blue-500' : 'bg-red-50 text-red-500'} rounded-full flex items-center justify-center text-[10px] font-bold">
                            ${l.type === 'ìˆ˜ì…' ? 'ì…' : 'ì¶œ'}
                        </div>
                        <div>
                            <p class="font-bold text-slate-700 text-sm">${l.detail}</p>
                            <p class="text-[10px] text-slate-300 font-medium">${l.date.toString().split('T')[0]}</p>
                        </div>
                    </div>
                    <div class="${l.type === 'ìˆ˜ì…' ? 'text-blue-600' : 'text-red-600'} font-black text-sm">
                        ${l.type === 'ìˆ˜ì…' ? '+' : '-'}${Number(l.amount).toLocaleString()}
                    </div>
                </div>
            `).join('') || '<p class="text-center text-slate-300 py-10 text-xs italic">ê¸°ë¡ëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        function showSection(type) {
            const section = document.getElementById('actionSection');
            const content = document.getElementById('sectionContent');
            section.classList.remove('hidden');

            if (type === 'members') {
                content.innerHTML = `
                    <h3 class="font-black text-xl mb-6">íšŒì› ì •ë³´ ê´€ë¦¬</h3>
                    <div class="bg-blue-50 p-5 rounded-3xl mb-8">
                        <p class="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-3">NEW MEMBER</p>
                        <div class="flex flex-col gap-2">
                            <input id="newMem" class="p-4 rounded-2xl border-none text-sm font-bold outline-none" placeholder="ì´ë¦„ ì…ë ¥">
                            <div class="flex gap-2 text-xs font-bold text-slate-400 pl-1 mb-1">ê°€ì… ì‹œì‘ì›” ì„ íƒ</div>
                            <input id="joinDate" type="month" class="p-4 rounded-2xl border-none text-sm font-bold outline-none" value="2025-01">
                            <button onclick="addMem()" class="bg-blue-600 text-white py-4 rounded-2xl font-black shadow-lg shadow-blue-100 mt-2">ë©¤ë²„ ì¶”ê°€í•˜ê¸°</button>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">ACTIVITY STATUS</p>
                        ${appData.members.map(m => `
                            <div class="flex justify-between items-center p-4 border border-slate-100 rounded-2xl">
                                <div>
                                    <span class="font-bold text-slate-700 text-sm">${m.name}</span>
                                    <span class="text-[9px] text-slate-300 ml-2">${m.joinDate} ê°€ì…</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <select onchange="updateStatus('${m.name}', this.value)" class="text-[10px] font-bold border-none bg-slate-100 rounded-lg p-2 outline-none">
                                        <option value="í™œë™" ${m.status==='í™œë™'?'selected':''}>í™œë™</option>
                                        <option value="íœ´ì‹" ${m.status==='íœ´ì‹'?'selected':''}>íœ´ì‹(ë¶€ìƒ ë“±)</option>
                                    </select>
                                    <i onclick="delMem('${m.name}')" class="fa-solid fa-circle-xmark text-slate-200 hover:text-red-400 cursor-pointer ml-1 text-lg"></i>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (type === 'payment') {
                const thisMonthStr = `${yearSel.value}-${monthSel.value}`;
                const thisMonthUnpaid = appData.unpaidSummary.filter(u => u.months.includes(thisMonthStr));
                content.innerHTML = `
                    <h3 class="font-black text-xl mb-2">${monthSel.value}ì›” íšŒë¹„ ë‚©ë¶€ ì²´í¬</h3>
                    <p class="text-xs text-slate-400 mb-6 font-medium">íšŒë¹„ë¥¼ ë‚©ë¶€í•œ ì¸ì›ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                    <div class="grid grid-cols-2 gap-2 mb-8" id="multiPayList">
                        ${thisMonthUnpaid.map(u => `
                            <label class="relative cursor-pointer group">
                                <input type="checkbox" name="payMember" value="${u.name}" class="hidden peer">
                                <span class="flex items-center justify-center p-4 border-2 border-slate-50 rounded-2xl bg-slate-50 text-slate-600 font-bold text-sm transition peer-checked:border-emerald-500 peer-checked:bg-emerald-50 peer-checked:text-emerald-700">
                                    ${u.name}
                                </span>
                            </label>
                        `).join('') || '<p class="col-span-2 text-center py-10 text-slate-300 text-sm italic font-medium">ì´ë²ˆ ë‹¬ ë¯¸ë‚©ìê°€ ì—†ìŠµë‹ˆë‹¤!</p>'}
                    </div>
                    <button onclick="submitMultiPay()" class="w-full bg-emerald-500 text-white py-5 rounded-[1.5rem] font-black shadow-xl shadow-emerald-100 text-lg active:scale-95 transition">ë‚©ë¶€ í™•ì¸ ë° ì €ì¥</button>
                `;
            } else if (type === 'income') {
                content.innerHTML = `
                    <h3 class="font-black text-xl mb-6">ê¸°íƒ€ ì…ì¶œê¸ˆ ê¸°ë¡</h3>
                    <div class="space-y-4">
                        <div class="flex gap-2 bg-slate-100 p-1 rounded-2xl">
                            <button id="btnIn" onclick="setTrType('ìˆ˜ì…')" class="flex-1 py-4 rounded-xl font-black text-sm transition active-tab">ìˆ˜ì…(+)</button>
                            <button id="btnOut" onclick="setTrType('ì§€ì¶œ')" class="flex-1 py-4 rounded-xl font-black text-sm transition">ì§€ì¶œ(-)</button>
                        </div>
                        <div class="space-y-1">
                            <p class="text-[10px] font-black text-slate-400 pl-1 uppercase">Date</p>
                            <input id="trDate" type="date" class="w-full bg-slate-50 p-4 rounded-2xl border-none outline-none font-bold text-slate-700" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="space-y-1">
                            <p class="text-[10px] font-black text-slate-400 pl-1 uppercase">Detail</p>
                            <input id="trDetail" class="w-full bg-slate-50 p-4 rounded-2xl border-none outline-none font-bold text-slate-700" placeholder="ë‚´ì—­ (ì˜ˆ: ìš´ë™ì¥ ëŒ€ê´€ë£Œ, ìŒë£Œìˆ˜)">
                        </div>
                        <div class="space-y-1">
                            <p class="text-[10px] font-black text-slate-400 pl-1 uppercase">Amount</p>
                            <input id="trAmount" type="number" class="w-full bg-slate-50 p-4 rounded-2xl border-none outline-none font-bold text-slate-700" placeholder="0">
                        </div>
                        <button onclick="addTr()" class="w-full bg-slate-900 text-white py-5 rounded-[1.5rem] font-black shadow-xl mt-4 active:scale-95 transition">ê¸°ë¡ ì €ì¥í•˜ê¸°</button>
                    </div>
                `;
                window.trType = 'ìˆ˜ì…';
            }
        }

        // --- ê¸°ëŠ¥ ì‹¤í–‰ í•¨ìˆ˜ë“¤ ---

        function setTrType(type) {
            window.trType = type;
            document.getElementById('btnIn').classList.toggle('active-tab', type==='ìˆ˜ì…');
            document.getElementById('btnOut').classList.toggle('active-tab', type==='ì§€ì¶œ');
        }

        async function addMem() {
            const name = document.getElementById('newMem').value;
            const date = document.getElementById('joinDate').value;
            if(!name) return alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
            await fetch(`${API_URL}?action=addMember&name=${name}&joinDate=${date}`);
            hideSection(); fetchData();
        }

        async function updateStatus(name, status) {
            await fetch(`${API_URL}?action=updateStatus&name=${name}&status=${status}`);
            fetchData();
        }

        async function delMem(name) {
            if(!confirm(`${name} íšŒì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            await fetch(`${API_URL}?action=deleteMember&name=${name}`);
            fetchData();
        }

        async function submitMultiPay() {
            const selected = Array.from(document.querySelectorAll('input[name="payMember"]:checked')).map(el => el.value);
            if(selected.length === 0) return alert('ë‚©ë¶€ìë¥¼ 1ëª… ì´ìƒ ì„ íƒí•˜ì„¸ìš”.');
            await fetch(`${API_URL}?action=recordMultiPayments&names=${JSON.stringify(selected)}&year=${yearSel.value}&month=${monthSel.value}`);
            hideSection(); fetchData();
        }

        async function addTr() {
            const type = window.trType;
            const detail = document.getElementById('trDetail').value;
            const amount = document.getElementById('trAmount').value;
            const date = document.getElementById('trDate').value;
            if(!detail || !amount) return alert('í•­ëª©ê³¼ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.');
            await fetch(`${API_URL}?action=addTransaction&type=${type}&detail=${detail}&amount=${amount}&date=${date}`);
            hideSection(); fetchData();
        }

        function hideSection() { document.getElementById('actionSection').classList.add('hidden'); }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° í˜¸ì¶œ
        window.onload = fetchData;
    </script>
</body>
</html>
