<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš©ì„±ì „ê¸°(ì£¼) í’‹ì‚´ ê´€ë¦¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slide-up 0.3s ease-out; }
        .active-tab { background-color: #3b82f6 !important; color: white !important; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-10">
    <div class="max-w-md mx-auto p-4 space-y-4">
        
        <div class="text-center py-4">
            <h1 class="text-2xl font-black text-gray-800 flex justify-center items-center gap-2">
                <i class="fa-solid fa-soccer-ball text-blue-600"></i>
                ìš©ì„±ì „ê¸°(ì£¼) í’‹ì‚´ íšŒë¹„
            </h1>
        </div>

        <div class="bg-slate-900 rounded-[2.5rem] p-8 text-white shadow-2xl relative overflow-hidden">
            <p class="text-[10px] opacity-50 font-bold tracking-[0.2em] mb-1">TOTAL BALANCE</p>
            <div class="text-4xl font-black text-green-400" id="totalBalance">0ì›</div>
            <div class="mt-6 flex gap-2">
                <select id="viewYear" onchange="fetchData()" class="bg-white/10 border-none rounded-lg text-xs p-2 outline-none"></select>
                <select id="viewMonth" onchange="fetchData()" class="bg-white/10 border-none rounded-lg text-xs p-2 outline-none"></select>
            </div>
        </div>

        <div class="bg-white rounded-3xl p-6 shadow-sm border">
            <h2 class="font-bold text-sm text-gray-400 mb-4 flex justify-between items-center">
                <span><i class="fa-solid fa-clock-rotate-left mr-2"></i>ëˆ„ì  ë¯¸ë‚© ëª…ë‹¨</span>
                <span class="bg-red-100 text-red-500 text-[10px] px-2 py-0.5 rounded-full" id="unpaidTotalInfo">0ëª…</span>
            </h2>
            <div id="unpaidList" class="space-y-3">
                </div>
        </div>

        <div class="grid grid-cols-3 gap-3">
            <button onclick="showSection('members')" class="bg-white p-4 rounded-2xl shadow-sm border flex flex-col items-center active:scale-95 transition">
                <i class="fa-solid fa-users-gear text-indigo-500 mb-1"></i>
                <span class="text-[10px] font-bold">ë©¤ë²„/íœ´ì‹</span>
            </button>
            <button onclick="showSection('payment')" class="bg-white p-4 rounded-2xl shadow-sm border flex flex-col items-center active:scale-95 transition">
                <i class="fa-solid fa-money-check-dollar text-emerald-500 mb-1"></i>
                <span class="text-[10px] font-bold">íšŒë¹„ì…ë ¥</span>
            </button>
            <button onclick="showSection('income')" class="bg-white p-4 rounded-2xl shadow-sm border flex flex-col items-center active:scale-95 transition">
                <i class="fa-solid fa-file-invoice-dollar text-orange-500 mb-1"></i>
                <span class="text-[10px] font-bold">ìˆ˜ì…/ì§€ì¶œ</span>
            </button>
        </div>

        <div class="bg-white rounded-3xl p-6 shadow-sm border min-h-[300px]">
            <h3 class="font-black text-gray-800 mb-5 flex justify-between items-center text-sm">
                <span>ğŸ“‘ <span id="monthLabel"></span> ë‚´ì—­</span>
            </h3>
            <div id="monthlyLogs" class="space-y-4"></div>
        </div>
    </div>

    <div id="actionSection" class="hidden fixed inset-0 bg-black/60 z-50 flex items-end">
        <div class="bg-white w-full rounded-t-[2.5rem] p-8 animate-slide-up max-h-[85vh] overflow-y-auto">
            <div id="sectionContent"></div>
            <button onclick="hideSection()" class="w-full mt-6 py-4 bg-gray-50 rounded-2xl font-bold text-gray-400">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbz3rsxELn2976--EQv27UarheFevKKpdPskF1viJ4AvZ2-Tizc78kbbcWmopXIQsG4Azw/exec';
        let appData = {};

        // ì—°ì›” ì„¸íŒ…
        const now = new Date();
        const yearSel = document.getElementById('viewYear');
        const monthSel = document.getElementById('viewMonth');
        for(let i=2025; i<=2026; i++) yearSel.innerHTML += `<option value="${i}" ${i==now.getFullYear()?'selected':''}>${i}ë…„</option>`;
        for(let i=1; i<=12; i++) monthSel.innerHTML += `<option value="${i}" ${i==now.getMonth()+1?'selected':''}>${i}ì›”</option>`;

        async function fetchData() {
            const y = yearSel.value; const m = monthSel.value;
            document.getElementById('monthLabel').innerText = `${m}ì›”`;
            const resp = await fetch(`${API_URL}?action=getData&year=${y}&month=${m}`);
            appData = await resp.json();
            renderUI();
        }

        function renderUI() {
            document.getElementById('totalBalance').innerText = appData.totalBalance.toLocaleString() + 'ì›';
            document.getElementById('unpaidTotalInfo').innerText = `${appData.unpaidSummary.length}ëª…`;
            
            document.getElementById('unpaidList').innerHTML = appData.unpaidSummary.map(u => `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl border border-gray-100">
                    <div>
                        <span class="font-bold text-gray-700 text-sm">${u.name}</span>
                        <p class="text-[9px] text-red-400 font-medium">${u.months.join(', ')} ë¯¸ë‚©</p>
                    </div>
                    <span class="bg-red-500 text-white text-[10px] px-2 py-1 rounded-lg font-bold">${u.months.length}íšŒ</span>
                </div>
            `).join('') || '<p class="text-center text-green-500 font-bold text-sm py-4">ëª¨ë“  íšŒì› ì™„ë‚© ì¤‘! âš½</p>';

            document.getElementById('monthlyLogs').innerHTML = appData.monthlyLogs.map(l => `
                <div class="flex justify-between items-center border-b border-gray-50 pb-3">
                    <div>
                        <p class="text-[10px] text-gray-400">${l.date.toString().split('T')[0]}</p>
                        <p class="font-bold text-gray-700 text-sm">${l.detail}</p>
                    </div>
                    <div class="${l.type === 'ìˆ˜ì…' ? 'text-blue-500' : 'text-red-500'} font-black text-sm">
                        ${l.type === 'ìˆ˜ì…' ? '+' : '-'}${Number(l.amount).toLocaleString()}
                    </div>
                </div>
            `).join('') || '<p class="text-center text-gray-300 py-10 text-sm">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        function showSection(type) {
            const section = document.getElementById('actionSection');
            const content = document.getElementById('sectionContent');
            section.classList.remove('hidden');

            if (type === 'members') {
                content.innerHTML = `
                    <h3 class="font-black text-xl mb-6">íšŒì› ì •ë³´ ê´€ë¦¬</h3>
                    <div class="space-y-6">
                        <div class="bg-blue-50 p-4 rounded-2xl">
                            <p class="text-xs font-bold text-blue-500 mb-2">ì‹ ê·œ íšŒì› ì¶”ê°€</p>
                            <input id="newMem" class="w-full p-3 rounded-xl mb-2 border-none" placeholder="ì´ë¦„">
                            <input id="joinDate" type="month" class="w-full p-3 rounded-xl mb-3 border-none" value="2025-01">
                            <button onclick="addMem()" class="w-full bg-blue-500 text-white py-3 rounded-xl font-bold">ë©¤ë²„ ì¶”ê°€</button>
                        </div>
                        <div class="space-y-2">
                            <p class="text-xs font-bold text-gray-400">í™œë™ ìƒíƒœ ë³€ê²½ (ë¶€ìƒ ë“±)</p>
                            ${appData.members.map(m => `
                                <div class="flex justify-between items-center p-3 border rounded-xl">
                                    <span class="font-bold text-sm">${m.name} <span class="text-[10px] font-normal text-gray-400">(${m.joinDate})</span></span>
                                    <select onchange="updateStatus('${m.name}', this.value)" class="text-xs border-none bg-gray-100 rounded-lg p-1">
                                        <option value="í™œë™" ${m.status==='í™œë™'?'selected':''}>í™œë™</option>
                                        <option value="íœ´ì‹" ${m.status==='íœ´ì‹'?'selected':''}>íœ´ì‹</option>
                                    </select>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else if (type === 'payment') {
                // ì´ë²ˆ ë‹¬ ë¯¸ë‚©ìë§Œ í•„í„°ë§í•´ì„œ ë³´ì—¬ì£¼ê¸°
                const thisMonthStr = `${yearSel.value}-${monthSel.value}`;
                const thisMonthUnpaid = appData.unpaidSummary.filter(u => u.months.includes(thisMonthStr));
                content.innerHTML = `
                    <h3 class="font-black text-xl mb-2">${monthSel.value}ì›” íšŒë¹„ ì²´í¬</h3>
                    <p class="text-xs text-gray-400 mb-6">ë‚©ë¶€í•œ ì¸ì›ì„ ì„ íƒí•˜ì„¸ìš”.</p>
                    <div class="grid grid-cols-3 gap-2 mb-6" id="multiPayList">
                        ${thisMonthUnpaid.map(u => `
                            <label class="flex flex-col items-center p-4 border rounded-2xl has-[:checked]:bg-green-50 has-[:checked]:border-green-500 transition cursor-pointer">
                                <input type="checkbox" name="payMember" value="${u.name}" class="hidden">
                                <span class="text-sm font-bold text-gray-600">${u.name}</span>
                            </label>
                        `).join('')}
                    </div>
                    <button onclick="submitMultiPay()" class="w-full bg-emerald-500 text-white py-4 rounded-2xl font-bold shadow-lg shadow-emerald-100 text-lg">ë‚©ë¶€ ì²˜ë¦¬ ì™„ë£Œ</button>
                `;
            } else if (type === 'income') {
                content.innerHTML = `
                    <h3 class="font-black text-xl mb-6">ê¸°íƒ€ ì§€ì¶œ ë° ìˆ˜ì…</h3>
                    <div class="space-y-4">
                        <div class="flex gap-2">
                            <button id="btnIn" onclick="setTrType('ìˆ˜ì…')" class="flex-1 py-4 border rounded-2xl font-bold active-tab">ìˆ˜ì…</button>
                            <button id="btnOut" onclick="setTrType('ì§€ì¶œ')" class="flex-1 py-4 border rounded-2xl font-bold">ì§€ì¶œ</button>
                        </div>
                        <input id="trDate" type="date" class="w-full bg-gray-50 p-4 rounded-2xl border-none" value="${new Date().toISOString().split('T')[0]}">
                        <input id="trDetail" class="w-full bg-gray-50 p-4 rounded-2xl border-none" placeholder="ë‚´ì—­ (ì˜ˆ: ìš´ë™ì¥ ëŒ€ê´€ë£Œ)">
                        <input id="trAmount" type="number" class="w-full bg-gray-50 p-4 rounded-2xl border-none" placeholder="ê¸ˆì•¡">
                        <button onclick="addTr()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold shadow-xl">ì €ì¥í•˜ê¸°</button>
                    </div>
                `;
                window.trType = 'ìˆ˜ì…';
            }
        }

        async function addMem() {
            const name = document.getElementById('newMem').value;
            const date = document.getElementById('joinDate').value;
            await fetch(`${API_URL}?action=addMember&name=${name}&joinDate=${date}`);
            hideSection(); fetchData();
        }

        async function updateStatus(name, status) {
            await fetch(`${API_URL}?action=updateStatus&name=${name}&status=${status}`);
            fetchData();
        }

        function setTrType(type) {
            window.trType = type;
            document.getElementById('btnIn').classList.toggle('active-tab', type==='ìˆ˜ì…');
            document.getElementById('btnOut').classList.toggle('active-tab', type==='ì§€ì¶œ');
        }

        async function submitMultiPay() {
            const selected = Array.from(document.querySelectorAll('input[name="payMember"]:checked')).map(el => el.value);
            if(selected.length === 0) return alert('ë‚©ë¶€ìë¥¼ ì„ íƒí•˜ì„¸ìš”.');
            await fetch(`${API_URL}?action=recordMultiPayments&names=${JSON.stringify(selected)}&year=${yearSel.value}&month=${monthSel.value}`);
            hideSection(); fetchData();
        }

        async function addTr() {
            const type = window.trType;
            const detail = document.getElementById('trDetail').value;
            const amount = document.getElementById('trAmount').value;
            const date = document.getElementById('trDate').value;
            await fetch(`${API_URL}?action=addTransaction&type=${type}&detail=${detail}&amount=${amount}&date=${date}`);
            hideSection(); fetchData();
        }

        function hideSection() { document.getElementById('actionSection').classList.add('hidden'); }
        window.onload = fetchData;
    </script>
</body>
</html>
