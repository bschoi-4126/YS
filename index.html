<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <title>ìš©ì„±ì „ê¸° í’‹ì‚´ íšŒë¹„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @font-face { font-family: 'Pretendard-Regular'; src: url('https://cdn.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff') format('woff'); }
        body { font-family: 'Pretendard-Regular', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        .app-container { max-width: 500px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column; }
        .content-area { flex: 1; overflow-y: auto; padding-bottom: 100px; }
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; max-width: 500px; margin: 0 auto; background: white; border-top: 1px solid #f1f5f9; display: flex; justify-content: space-around; padding: 12px 0 24px 0; z-index: 100; box-shadow: 0 -4px 6px -1px rgb(0 0 0 / 0.1); }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #94a3b8; font-size: 10px; font-weight: 700; width: 25%; }
        .nav-item.active { color: #3b82f6; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        .active-tab { background-color: #3b82f6 !important; color: white !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50">

    <div class="app-container">
        <header class="p-6 bg-white flex justify-between items-center border-b">
            <h1 class="text-xl font-black text-slate-800 italic">YONG SUNGâš½</h1>
            <div class="flex items-center gap-2">
                <select id="viewYear" onchange="fetchData()" class="text-xs font-bold bg-slate-100 p-2 rounded-lg border-none outline-none"></select>
                <select id="viewMonth" onchange="fetchData()" class="text-xs font-bold bg-slate-100 p-2 rounded-lg border-none outline-none"></select>
            </div>
        </header>

        <main class="content-area p-4 space-y-4">
            <div class="bg-slate-900 rounded-[2rem] p-8 text-white shadow-xl relative overflow-hidden">
                <p class="text-[10px] opacity-50 font-bold tracking-widest mb-1 uppercase">Total Balance</p>
                <div class="text-4xl font-black text-green-400" id="totalBalance">0ì›</div>
                <i class="fa-solid fa-coins absolute -right-4 -bottom-4 text-8xl opacity-10"></i>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white rounded-3xl p-5 shadow-sm border border-blue-50 text-center">
                    <p class="text-[10px] text-blue-500 font-bold mb-1 uppercase tracking-tighter" id="yearlyIncomeTitle">ì—°ê°„ ì´ ìˆ˜ì…</p>
                    <p class="text-lg font-black text-slate-800" id="yearlyIncome">0ì›</p>
                </div>
                <div class="bg-white rounded-3xl p-5 shadow-sm border border-red-50 text-center">
                    <p class="text-[10px] text-red-500 font-bold mb-1 uppercase tracking-tighter" id="yearlyExpenseTitle">ì—°ê°„ ì´ ì§€ì¶œ</p>
                    <p class="text-lg font-black text-slate-800" id="yearlyExpense">0ì›</p>
                </div>
            </div>

            <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100">
                <h2 class="font-bold text-xs text-slate-400 mb-4 flex justify-between items-center uppercase tracking-widest">
                    <span><i class="fa-solid fa-clock-rotate-left mr-2"></i>ëˆ„ì  ë¯¸ë‚© ëª…ë‹¨ (í˜„ì¬ ê¸°ì¤€)</span>
                    <span id="unpaidSummaryCount" class="bg-red-50 text-red-500 px-2 py-0.5 rounded-full text-[10px] font-black">0</span>
                </h2>
                <div id="unpaidList" class="space-y-3"></div>
            </div>

            <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-100 min-h-[400px]">
                <h3 class="font-bold text-slate-800 mb-5 text-sm uppercase tracking-widest">ğŸ“… <span id="monthLabel"></span> ìƒì„¸ ë‚´ì—­</h3>
                <div id="monthlyLogs" class="space-y-4 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar"></div>
            </div>
        </main>

        <nav class="nav-bar">
            <button onclick="location.reload()" class="nav-item active"><i class="fa-solid fa-house text-xl"></i><span>í™ˆ</span></button>
            <button onclick="showSection('payment')" class="nav-item"><i class="fa-solid fa-circle-check text-xl"></i><span>íšŒë¹„ì…ë ¥</span></button>
            <button onclick="showSection('income')" class="nav-item"><i class="fa-solid fa-receipt text-xl"></i><span>ì…ì¶œê¸ˆ</span></button>
            <button onclick="showSection('members')" class="nav-item"><i class="fa-solid fa-user-gear text-xl"></i><span>ë©¤ë²„</span></button>
        </nav>
    </div>

    <div id="actionSection" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[200] flex items-end">
        <div class="bg-white w-full rounded-t-[2.5rem] p-8 animate-slide-up max-h-[85vh] overflow-y-auto">
            <div id="sectionContent"></div>
            <button onclick="hideSection()" class="w-full mt-6 py-4 bg-gray-100 rounded-2xl font-bold text-gray-400">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbyK107gsKmFhydwYes19qSHrYPyN6NmlRxLPMOtfr9V8EyhCBHTp1J9FpcDZSCaFxS-RA/exec';
        let appData = { totalBalance: 0, yearlyIncome: 0, yearlyExpense: 0, unpaidSummary: [], members: [], monthlyLogs: [] };

        const now = new Date();
        const yearSel = document.getElementById('viewYear');
        const monthSel = document.getElementById('viewMonth');
        for(let i=2025; i<=2030; i++) yearSel.innerHTML += `<option value="${i}" ${i==now.getFullYear()?'selected':''}>${i}ë…„</option>`;
        for(let i=1; i<=12; i++) monthSel.innerHTML += `<option value="${i}" ${i==now.getMonth()+1?'selected':''}>${i}ì›”</option>`;

        async function fetchData() {
            const y = yearSel.value; const m = monthSel.value;
            document.getElementById('monthLabel').innerText = `${m}ì›”`;
            document.getElementById('yearlyIncomeTitle').innerText = `${y}ë…„ ì´ ìˆ˜ì…`;
            document.getElementById('yearlyExpenseTitle').innerText = `${y}ë…„ ì´ ì§€ì¶œ`;
            try {
                const resp = await fetch(`${API_URL}?action=getData&year=${y}&month=${m}`);
                appData = await resp.json();
                renderUI();
            } catch (e) { alert("ì—°ë™ ì‹¤íŒ¨"); }
        }

        function renderUI() {
            document.getElementById('totalBalance').innerText = (appData.totalBalance || 0).toLocaleString() + 'ì›';
            document.getElementById('yearlyIncome').innerText = (appData.yearlyIncome || 0).toLocaleString() + 'ì›';
            document.getElementById('yearlyExpense').innerText = (appData.yearlyExpense || 0).toLocaleString() + 'ì›';
            
            const realArrears = appData.unpaidSummary.filter(u => u.months.length > 0 && u.status === 'í™œë™');
            document.getElementById('unpaidSummaryCount').innerText = realArrears.length;
            document.getElementById('unpaidList').innerHTML = realArrears.map(u => `
                <div class="flex justify-between items-center bg-slate-50 p-3 rounded-2xl border border-slate-100">
                    <div><span class="font-bold text-slate-700 text-sm">${u.name}</span><p class="text-[9px] text-red-400 font-medium">${u.months.slice(-3).join(', ')} ë¯¸ë‚©</p></div>
                    <span class="bg-red-500 text-white text-[10px] px-2 py-1 rounded-lg font-black">${u.months.length}íšŒ</span>
                </div>
            `).join('') || '<p class="text-center text-emerald-500 font-bold text-xs py-2">ì™„ë‚© ì¤‘! âš½</p>';

            // ìµœì‹  ë‚´ì—­ì´ ìœ„ë¡œ ì˜¤ë„ë¡ ë Œë”ë§
            document.getElementById('monthlyLogs').innerHTML = appData.monthlyLogs.map(l => `
                <div class="flex justify-between items-center border-b border-slate-50 pb-4">
                    <div class="flex gap-4 items-center">
                        <div onclick="deleteLog('${l.logType}', '${l.id}', '${l.detail}', ${l.amount}, '${l.type}')" class="text-red-500 hover:text-red-700 transition cursor-pointer px-2 py-1 bg-red-50 rounded-lg">
                            <i class="fa-solid fa-trash-can text-sm"></i>
                        </div>
                        <div>
                            <p class="font-bold text-slate-700 text-sm">${l.detail}</p>
                            <p class="text-[10px] text-slate-300">${l.date.toString().split('T')[0]}</p>
                        </div>
                    </div>
                    <div class="${l.type === 'ìˆ˜ì…' ? 'text-blue-600' : 'text-red-600'} font-black text-sm text-right">
                        ${l.type === 'ìˆ˜ì…' ? '+' : '-'}${Number(l.amount).toLocaleString()}
                    </div>
                </div>
            `).join('') || '<p class="text-center text-slate-300 py-10 text-xs italic">ë‚´ì—­ ì—†ìŒ</p>';
        }

        async function submitMultiPay() {
            const selected = Array.from(document.querySelectorAll('input[name="payMember"]:checked')).map(el => el.value);
            if(selected.length === 0) return alert('ì¸ì›ì„ ì„ íƒí•˜ì„¸ìš”.');

            // [ì¦‰ê° ë°˜ì˜] UI ìµœìƒë‹¨ì— ì¶”ê°€ (unshift)
            selected.forEach(name => {
                const member = appData.unpaidSummary.find(u => u.name === name);
                if(member) {
                    member.isTargetUnpaid = false;
                    member.months = member.months.filter(m => m !== `${yearSel.value}-${parseInt(monthSel.value)}`);
                    appData.totalBalance += 10000;
                    appData.yearlyIncome += 10000;
                    appData.monthlyLogs.unshift({ id: Date.now(), date: 'íšŒë¹„', type: 'ìˆ˜ì…', detail: `${name} íšŒë¹„`, amount: 10000, logType: 'fee' });
                }
            });
            renderUI(); hideSection();

            try {
                await fetch(`${API_URL}?action=recordMultiPayments&names=${JSON.stringify(selected)}&year=${yearSel.value}&month=${monthSel.value}`);
                fetchData();
            } catch(e) { alert("ì„œë²„ ì €ì¥ ì‹¤íŒ¨"); fetchData(); }
        }

        async function addTr() {
            const type = window.trType;
            const detail = document.getElementById('trDetail').value;
            const amount = Number(document.getElementById('trAmount').value);
            const date = document.getElementById('trDate').value;
            if(!detail || !amount) return alert('ë‚´ìš©ê³¼ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.');

            // [ì¦‰ê° ë°˜ì˜] UI ìµœìƒë‹¨ì— ì¶”ê°€ (unshift)
            appData.totalBalance += (type === 'ìˆ˜ì…' ? amount : -amount);
            if(new Date(date).getFullYear() == yearSel.value) {
                if(type === 'ìˆ˜ì…') appData.yearlyIncome += amount;
                else appData.yearlyExpense += amount;
            }
            appData.monthlyLogs.unshift({ id: Date.now(), date: date, type: type, detail: detail, amount: amount, logType: 'trans' });
            renderUI(); hideSection();

            try {
                await fetch(`${API_URL}?action=addTransaction&type=${type}&detail=${detail}&amount=${amount}&date=${date}`);
                fetchData();
            } catch(e) { alert("ì €ì¥ ì‹¤íŒ¨"); fetchData(); }
        }

        async function deleteLog(logType, id, detail, amount, type) {
            if(!confirm(`[${detail}] ì‚­ì œí• ê¹Œìš”?`)) return;

            appData.monthlyLogs = appData.monthlyLogs.filter(l => l.id != id);
            appData.totalBalance -= (type === 'ìˆ˜ì…' ? amount : -amount);
            if(type === 'ìˆ˜ì…') appData.yearlyIncome -= amount; else appData.yearlyExpense -= amount;
            renderUI();

            try {
                await fetch(`${API_URL}?action=deleteLog&type=${logType}&id=${id}`);
                fetchData();
            } catch(e) { alert("ì‚­ì œ ì‹¤íŒ¨"); fetchData(); }
        }

        async function addMem() {
            const name = document.getElementById('newMem').value;
            const date = document.getElementById('joinDate').value;
            if(!name) return;
            appData.members.push({ name, joinDate: date, status: 'í™œë™' });
            renderUI(); hideSection();
            try {
                await fetch(`${API_URL}?action=addMember&name=${name}&joinDate=${date}`);
                fetchData();
            } catch(e) { alert("ì¶”ê°€ ì‹¤íŒ¨"); fetchData(); }
        }

        async function updateStatus(name, status) {
            const member = appData.members.find(m => m.name === name);
            if(member) member.status = status;
            renderUI();
            try {
                await fetch(`${API_URL}?action=updateStatus&name=${name}&status=${status}`);
                fetchData();
            } catch(e) { alert("ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨"); fetchData(); }
        }

        function showSection(type) {
            const section = document.getElementById('actionSection');
            const content = document.getElementById('sectionContent');
            section.classList.remove('hidden');
            history.pushState({ section: type }, '');
            if (type === 'payment') {
                const targetUnpaid = appData.unpaidSummary.filter(u => u.isTargetUnpaid && u.status === 'í™œë™');
                content.innerHTML = `<h3 class="font-black text-xl mb-4">${monthSel.value}ì›” íšŒë¹„ ì²´í¬</h3><div class="grid grid-cols-2 gap-2 mb-6">
                ${targetUnpaid.map(u => `<label class="cursor-pointer"><input type="checkbox" name="payMember" value="${u.name}" class="hidden peer">
                <span class="flex items-center justify-center p-4 border rounded-2xl bg-slate-50 font-bold text-sm peer-checked:border-emerald-500 peer-checked:bg-emerald-50 peer-checked:text-emerald-700">${u.name}</span></label>`).join('') || '<p class="col-span-2 text-center py-10 text-slate-300">ë‚©ë¶€í•  ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>'}
                </div><button onclick="submitMultiPay()" class="w-full bg-emerald-500 text-white py-5 rounded-2xl font-black shadow-lg">ë‚©ë¶€ ì €ì¥</button>`;
            } else if (type === 'income') {
                content.innerHTML = `<h3 class="font-black text-xl mb-6">ê¸°íƒ€ ì…ì¶œê¸ˆ</h3><div class="space-y-4"><div class="flex gap-2 bg-slate-100 p-1 rounded-2xl">
                <button id="btnIn" onclick="setTrType('ìˆ˜ì…')" class="flex-1 py-3 rounded-xl font-black active-tab">ìˆ˜ì…</button><button id="btnOut" onclick="setTrType('ì§€ì¶œ')" class="flex-1 py-3 rounded-xl font-black">ì§€ì¶œ</button></div>
                <input id="trDate" type="date" class="w-full bg-slate-50 p-4 rounded-xl border-none font-bold outline-none" value="${new Date().toISOString().split('T')[0]}">
                <input id="trDetail" class="w-full bg-slate-50 p-4 rounded-xl border-none font-bold outline-none" placeholder="ë‚´ì—­">
                <input id="trAmount" type="number" class="w-full bg-slate-50 p-4 rounded-xl border-none font-bold outline-none" placeholder="ê¸ˆì•¡">
                <button onclick="addTr()" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black shadow-xl">ì €ì¥í•˜ê¸°</button></div>`; window.trType = 'ìˆ˜ì…';
            } else if (type === 'members') {
                content.innerHTML = `<h3 class="font-black text-xl mb-6">ë©¤ë²„ ê´€ë¦¬</h3><div class="bg-blue-50 p-5 rounded-3xl mb-6"><input id="newMem" class="w-full p-4 rounded-2xl mb-2 border-none font-bold outline-none" placeholder="ì´ë¦„">
                <input id="joinDate" type="month" class="w-full p-4 rounded-2xl mb-2 border-none font-bold outline-none" value="2025-01"><button onclick="addMem()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-black">ì¶”ê°€</button></div>
                <div class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar">${appData.members.map(m => `<div class="flex justify-between items-center p-4 border rounded-2xl"><span class="font-bold text-sm text-slate-600">${m.name}</span>
                <div class="flex items-center gap-2"><select onchange="updateStatus('${m.name}', this.value)" class="text-[10px] font-bold bg-slate-100 rounded-lg p-2 outline-none"><option value="í™œë™" ${m.status==='í™œë™'?'selected':''}>í™œë™</option><option value="íœ´ì‹" ${m.status==='íœ´ì‹'?'selected':''}>íœ´ì‹</option></select>
                <i onclick="delMem('${m.name}')" class="fa-solid fa-circle-xmark text-slate-300 ml-1 text-lg cursor-pointer"></i></div></div>`).join('')}</div>`;
            }
        }

        function setTrType(type) { window.trType = type; document.getElementById('btnIn').classList.toggle('active-tab', type==='ìˆ˜ì…'); document.getElementById('btnOut').classList.toggle('active-tab', type==='ì§€ì¶œ'); }
        async function delMem(name) { if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return; await fetch(`${API_URL}?action=deleteMember&name=${name}`); fetchData(); }
        function hideSection(isPopState = false) { document.getElementById('actionSection').classList.add('hidden'); if (!isPopState && history.state && history.state.section) { history.back(); } }
        window.onpopstate = function(event) { const section = document.getElementById('actionSection'); if (!section.classList.contains('hidden')) { hideSection(true); } };
        window.onload = fetchData;
    </script>
</body>
</html>
